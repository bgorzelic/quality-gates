.DEFAULT_GOAL := help
SHELL := /bin/bash

.PHONY: help verify install dev test lint format typecheck security clean

help: ## Show this help
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}'

verify: lint typecheck test security ## Run all quality checks

install: ## Install dependencies
	uv sync

dev: install ## Install dependencies + git hooks
	pre-commit install

test: ## Run tests with coverage
	uv run pytest --cov=src --cov-report=term-missing --tb=short

lint: ## Run linter
	uvx ruff check .

format: ## Format code
	uvx ruff format .
	uvx ruff check --fix .

typecheck: ## Run type checker
	uv run mypy src/

security: ## Run security checks
	uvx bandit -r src/ -c pyproject.toml
	uv pip compile pyproject.toml -o /tmp/requirements.txt 2>/dev/null && uvx pip-audit -r /tmp/requirements.txt

clean: ## Remove build artifacts
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name .mypy_cache -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name .ruff_cache -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name .pytest_cache -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	rm -rf dist/ build/ .coverage htmlcov/
